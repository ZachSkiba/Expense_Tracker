<!DOCTYPE html>
<html>
<head>
    <title>Manage Settlements</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/balance-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settlements.css') }}">
</head>
<body>

<h1>üí∞ Manage Settlements</h1>

{% if error %}
    <div class="error-message">{{ error }}</div>
{% endif %}

<h2>Record New Payment</h2>
<form method="POST" class="settlement-form">
    <div class="form-group">
        <label>Amount Paid</label>
        <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required autocomplete="off">
    </div>

    <div class="form-group">
        <label>Who Paid</label>
        <select name="payer_id" required autocomplete="off">
            <option value="" disabled {% if not payer_id %}selected{% endif %}>Select payer</option>
            {% for user in users %}
                <option value="{{ user.id }}" {% if payer_id == user.id|string %}selected{% endif %}>
                    {{ user.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label>Who Received Payment</label>
        <select name="receiver_id" required autocomplete="off">
            <option value="" disabled {% if not receiver_id %}selected{% endif %}>Select receiver</option>
            {% for user in users %}
                <option value="{{ user.id }}" {% if receiver_id == user.id|string %}selected{% endif %}>
                    {{ user.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label>Description (Optional)</label>
        <input type="text" name="description" value="{{ description or '' }}" placeholder="e.g., Venmo payment, cash, etc." autocomplete="off">
    </div>

    <div class="form-group">
        <label>Date</label>
        <input type="date" name="date" value="{{ date or '' }}" autocomplete="off">
    </div>

    <button type="submit" class="submit-btn">Record Payment</button>
</form>

<hr>

<h2>Payment History</h2>
{% if settlements %}
<div id="table-error" style="margin: 8px 0;"></div>
<table class="settlements-table">
    <thead>
        <tr>
            <th>Amount</th>
            <th>From</th>
            <th>To</th>
            <th>Description</th>
            <th>Date</th>
            <th>Recorded</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for settlement in settlements %}
        <tr data-settlement-id="{{ settlement.id }}">
            <td class="editable amount" data-field="amount" data-value="{{ "%.2f"|format(settlement.amount) }}">
                ${{ "%.2f"|format(settlement.amount) }}
            </td>
            <td class="editable payer" data-field="payer" data-value="{{ settlement.payer_name }}">
                {{ settlement.payer_name }}
            </td>
            <td class="editable receiver" data-field="receiver" data-value="{{ settlement.receiver_name }}">
                {{ settlement.receiver_name }}
            </td>
            <td class="editable description" data-field="description" data-value="{{ settlement.description or '' }}">
                {{ settlement.description or '-' }}
            </td>
            <td class="editable date" data-field="date" data-value="{{ settlement.date }}">
                {{ settlement.date }}
            </td>
            <td style="font-size: 0.85rem; color: #666;">{{ settlement.created_at }}</td>
            <td>
                <button class="delete-settlement-btn" data-settlement-id="{{ settlement.id }}">‚ùå Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script id="users-data" type="application/json">{{ users | tojson | safe }}</script>

<script>
// **UPDATED**: Use the same SettlementTableEditor logic as the SettlementManager
class SettlementTableEditor {
    constructor() {
        this.usersData = JSON.parse(document.getElementById('users-data').textContent || '[]');
        this.isEditing = false;
        this.editingCell = null;
        this.originalContent = null;
        this.initializeEditing();
        this.initializeDeleteButtons();
    }

    initializeEditing() {
        const editableCells = document.querySelectorAll('.settlements-table .editable');
        
        editableCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                this.startEditing(cell);
            });
        });
    }

    initializeDeleteButtons() {
        document.querySelectorAll('.delete-settlement-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const settlementId = button.getAttribute('data-settlement-id');
                this.deleteSettlement(settlementId);
            });
        });
    }

    startEditing(cell) {
        // Prevent multiple simultaneous edits
        if (this.isEditing) {
            return;
        }

        this.isEditing = true;
        this.editingCell = cell;
        
        const currentValue = cell.getAttribute('data-value') || '';
        const fieldType = cell.getAttribute('data-field');
        
        console.log(`[DEBUG] Starting edit for ${fieldType}: ${currentValue}`);
        cell.classList.add('editing');
        
        let inputElement;
        
        if (fieldType === 'amount') {
            inputElement = document.createElement('input');
            inputElement.type = 'number';
            inputElement.step = '0.01';
            inputElement.min = '0.01';
            inputElement.value = currentValue;
        } else if (fieldType === 'date') {
            inputElement = document.createElement('input');
            inputElement.type = 'date';
            inputElement.value = currentValue;
        } else if (fieldType === 'payer' || fieldType === 'receiver') {
            inputElement = document.createElement('select');
            this.usersData.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name;
                option.selected = user.name === currentValue;
                inputElement.appendChild(option);
            });
        } else {
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.value = currentValue;
        }
        
        inputElement.style.width = '100%';
        inputElement.style.border = '2px solid #3498db';
        inputElement.style.padding = '4px';
        inputElement.style.borderRadius = '4px';
        inputElement.style.boxSizing = 'border-box';
        
        // Store original content for cancellation
        this.originalContent = cell.innerHTML;
        
        // Replace cell content with input
        cell.innerHTML = '';
        cell.appendChild(inputElement);
        
        inputElement.focus();
        if (inputElement.type === 'text' || inputElement.type === 'number') {
            inputElement.select();
        }
        
        // Set up event handlers
        const handleSave = async () => {
            await this.saveEdit(inputElement);
        };
        
        const handleCancel = () => {
            this.cancelEdit();
        };
        
        inputElement.addEventListener('blur', handleSave, { once: true });
        
        inputElement.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                inputElement.blur();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                e.stopPropagation();
                handleCancel();
            }
        });
    }

    async saveEdit(inputElement) {
        if (!this.isEditing || !this.editingCell) {
            return;
        }

        const newValue = inputElement.value.trim();
        const cell = this.editingCell;
        const settlementId = cell.closest('tr').getAttribute('data-settlement-id');
        const fieldType = cell.getAttribute('data-field');
        const originalValue = cell.getAttribute('data-value') || '';
        
        console.log(`[DEBUG] Saving edit for ${fieldType}: ${originalValue} -> ${newValue}`);
        
        // If no change, just cancel
        if (newValue === originalValue) {
            this.cancelEdit();
            return;
        }

        try {
            const updateData = {};
            updateData[fieldType] = newValue;

            const response = await fetch(`/edit_settlement/${settlementId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });

            const data = await response.json();

            if (data.success) {
                console.log(`[DEBUG] Settlement edit successful for ${fieldType}`);
                
                // Update the data attribute
                cell.setAttribute('data-value', newValue);
                
                // Update the cell display
                if (fieldType === 'amount') {
                    cell.innerHTML = `$${parseFloat(newValue).toFixed(2)}`;
                } else if (fieldType === 'description' && !newValue) {
                    cell.innerHTML = '-';
                } else {
                    cell.innerHTML = newValue;
                }
                
                // Clean up editing state
                cell.classList.remove('editing');
                this.isEditing = false;
                this.editingCell = null;
                this.originalContent = null;
                
                // **KEY FIX**: Show success message like on main page
                this.showSuccessMessage('Settlement updated successfully');
                
                // **KEY FIX**: Force page refresh to show updated data immediately
                console.log('[DEBUG] Refreshing page after settlement edit...');
                setTimeout(() => {
                    window.location.reload();
                }, 1500); // Small delay to show success message
                
            } else {
                throw new Error(data.error || 'Update failed');
            }
        } catch (error) {
            console.error('Error saving settlement edit:', error);
            this.cancelEdit();
            this.showErrorMessage('Failed to update settlement: ' + error.message);
        }
    }

    cancelEdit() {
        if (!this.isEditing || !this.editingCell) {
            return;
        }

        console.log('[DEBUG] Canceling edit');
        const cell = this.editingCell;
        
        // Restore original content
        cell.innerHTML = this.originalContent;
        cell.classList.remove('editing');
        
        // Clean up state
        this.isEditing = false;
        this.editingCell = null;
        this.originalContent = null;
    }

    async deleteSettlement(settlementId) {
        if (!confirm('Are you sure you want to delete this settlement? This will reverse the balance changes.')) {
            return;
        }

        try {
            const response = await fetch(`/delete_settlement/${settlementId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                this.showSuccessMessage('Payment deleted successfully');
                // Refresh page to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                this.showErrorMessage('Error deleting settlement: ' + data.error);
            }
        } catch (error) {
            console.error('Error deleting settlement:', error);
            this.showErrorMessage('Error deleting settlement: ' + error.message);
        }
    }

    showSuccessMessage(message) {
        this.showTableMessage(message, 'success');
    }

    showErrorMessage(message) {
        this.showTableMessage(message, 'error');
    }

    showTableMessage(message, type = 'error') {
        const errorDiv = document.getElementById('table-error');
        if (errorDiv) {
            errorDiv.className = type;
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<div style="padding: 8px; border-radius: 4px; ${
                type === 'success' ? 'background: #d4edda; border: 1px solid #c3e6cb; color: #155724;' 
                : 'background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24;'
            }">${message}</div>`;
            
            // Don't auto-hide success messages if we're about to refresh
            if (type !== 'success') {
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }
    }
}

// Initialize the settlement table editor when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    new SettlementTableEditor();
});
</script>

{% else %}
<p style="text-align: center; color: #888; margin: 40px 0;">No payments recorded yet</p>
{% endif %}

<div style="margin-top: 30px; text-align: center;">
    <a href="{{ url_for('expenses.add_expense') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">‚¨Ö Back to Main</a>
    <a href="{{ url_for('balances.balances_page') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">üí∞ View Balances</a>
</div>

</body>
</html>