<!DOCTYPE html>
<html>
<head>
    <title>Manage Settlements</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/balance-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settlements.css') }}">
</head>
<body>

<h1>üí∞ Manage Settlements</h1>

{% if error %}
    <div class="error-message">{{ error }}</div>
{% endif %}

<h2>Record New Payment</h2>
<form method="POST" class="settlement-form">
    <div class="form-group">
        <label>Amount Paid</label>
        <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required>
    </div>

    <div class="form-group">
        <label>Who Paid</label>
        <select name="payer_id" required>
            <option value="" disabled {% if not payer_id %}selected{% endif %}>Select payer</option>
            {% for user in users %}
                <option value="{{ user.id }}" {% if payer_id == user.id|string %}selected{% endif %}>
                    {{ user.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label>Who Received Payment</label>
        <select name="receiver_id" required>
            <option value="" disabled {% if not receiver_id %}selected{% endif %}>Select receiver</option>
            {% for user in users %}
                <option value="{{ user.id }}" {% if receiver_id == user.id|string %}selected{% endif %}>
                    {{ user.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label>Description (Optional)</label>
        <input type="text" name="description" value="{{ description or '' }}" placeholder="e.g., Venmo payment, cash, etc.">
    </div>

    <div class="form-group">
        <label>Date</label>
        <input type="date" name="date" value="{{ date or '' }}">
    </div>

    <button type="submit" class="submit-btn">Record Payment</button>
</form>

<hr>

<h2>Payment History</h2>
{% if settlements %}
<div id="table-error" style="margin: 8px 0;"></div>
<table class="settlements-table">
    <thead>
        <tr>
            <th>Amount</th>
            <th>From</th>
            <th>To</th>
            <th>Description</th>
            <th>Date</th>
            <th>Recorded</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for settlement in settlements %}
        <tr data-settlement-id="{{ settlement.id }}">
            <td class="amount">${{ "%.2f"|format(settlement.amount) }}</td>
            <td>{{ settlement.payer_name }}</td>
            <td>{{ settlement.receiver_name }}</td>
            <td>{{ settlement.description or '-' }}</td>
            <td>{{ settlement.date }}</td>
            <td style="font-size: 0.85rem; color: #666;">{{ settlement.created_at }}</td>
            <td>
                <button class="delete-settlement-btn" data-settlement-id="{{ settlement.id }}">‚ùå Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
// Handle settlement deletion
document.querySelectorAll('.delete-settlement-btn').forEach(button => {
    button.addEventListener('click', function() {
        const settlementId = this.getAttribute('data-settlement-id');
        
        if (confirm('Are you sure you want to delete this settlement? This will reverse the balance changes.')) {
            fetch(`/delete_settlement/${settlementId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Refresh to show updated data
                } else {
                    alert('Error deleting settlement: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error deleting settlement: ' + error);
            });
        }
    });
});
</script>

{% else %}
<p style="text-align: center; color: #888; margin: 40px 0;">No payments recorded yet</p>
{% endif %}

<div style="margin-top: 30px; text-align: center;">
    <a href="{{ url_for('expenses.add_expense') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">‚¨Ö Back to Main</a>
    <a href="{{ url_for('balances.balances_page') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">üí∞ View Balances</a>
</div>


</body>
</html>