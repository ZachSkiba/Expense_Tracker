<!DOCTYPE html>
<html>
<head>
    <title>Add Expense</title>
     <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Add Expense</h1>

    {% if error %}
        <p style="color:red;">{{ error }}</p>
    {% endif %}

    

    <form method="POST" id="expense-form">
        <!-- Amount -->
        <label>Amount:</label>
        <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required><br><br>

        <!-- Category -->
        <label>Category:</label>
        <select id="category-select" name="category_id" required onchange="handleCategoryChange(this)">
            <option value="" disabled selected>Select category</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if selected_category_id == cat.id|string %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
            <option value="manage">âž• Add/Remove Categories</option>
        </select>

        <!-- Description / Store -->
        <div id="category-desc-container" style="display:none;">
            <label>Description / Store:</label>
            <input type="text" id="category-description" name="category_description" value="{{ category_description or '' }}" autocomplete="off">
            <div id="suggestions-container" style="border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto; position:absolute; background:white;"></div>
        </div>
        <br><br>

        <!-- Paid By -->
        <label>Paid By:</label>
        <select id="user-select" name="user_id" required onchange="handleUserChange(this)">
            <option value="" disabled selected>Select user</option>
            {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id|string %}selected{% endif %}>
                    {{ user.name }}
                </option>
            {% endfor %}
            <option value="manage">âž• Add/Remove Users</option>
        </select><br><br>

        <!-- NEW: Participants Section -->
        <div class="participants-section">
            <h3 class="participants-title">Who participated in this expense?</h3>
            <p class="participants-subtitle">
                Select everyone who should split this expense (including the person who paid)
            </p>
            
            <button type="button" class="select-all-btn" onclick="toggleAllParticipants()">Select All</button>

            <div id="participants-list" class="participants-grid">
                {% for user in users %}
                <div class="participant-checkbox">
                    <input type="checkbox" 
                        id="participant-{{ user.id }}" 
                        name="participant_ids" 
                        value="{{ user.id }}"
                        onchange="updateSplitPreview()">
                    <label for="participant-{{ user.id }}">{{ user.name }}</label>
                </div>
                {% endfor %}
            </div>
            
            <div id="split-preview" class="split-preview" style="display: none;">
                <strong>Split Preview:</strong>
                <div id="split-details"></div>
            </div>
        </div>

        <!-- Date -->
        <div>
            <label>Date:</label>
            <input type="date" name="date" value="{{ date or '' }}">
        </div>
        <br>

        <button type="submit">Add Expense</button>
    </form>

    <br>
    <a href="{{ url_for('expenses.expenses') }}">View All Expenses</a><br>
    <a href="{{ url_for('balances.balances_page') }}">ðŸ’° View Balances</a><br>
    <a href="{{ url_for('manage.management') }}">â¬… Back to Management</a>

<hr>
{% include "_expenses_table.html" %} 



<!-- Data for JavaScript -->
<script id="categories-data" type="application/json">{{ categories | tojson | safe }}</script>
<script id="users-data" type="application/json">{{ users | tojson | safe }}</script>

<script>
    // Make URLs available to JavaScript modules
    window.urls = {
        addExpense: "{{ url_for('expenses.add_expense') }}",
        manageCategories: "{{ url_for('categories.manage_categories') }}",
        manageUsers: "{{ url_for('users.manage_users') }}"
    };
</script>

<!-- Load JavaScript modules -->
<script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/expense-table-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/expense-form-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>

</body>
</html>