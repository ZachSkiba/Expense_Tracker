<!DOCTYPE html>
<html>
<head>
    <title>Add Expense</title>
     <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Add Expense</h1>

    {% if error %}
        <p style="color:red;">{{ error }}</p>
    {% endif %}

    <form method="POST" id="expense-form">
        <!-- Amount -->
        <label>Amount:</label>
        <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required><br><br>

        <!-- Category -->
        <label>Category:</label>
        <select id="category-select" name="category_id" required onchange="handleCategoryChange(this)">
            <option value="" disabled selected>Select category</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if selected_category_id == cat.id|string %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
            <option value="manage">➕ Add/Remove Categories</option>
        </select>

        <!-- Description / Store -->
        <div id="category-desc-container" style="display:none;">
            <label>Description / Store:</label><br>
            <input type="text" id="category-description" name="category_description" value="{{ category_description or '' }}" autocomplete="off">
            <div id="suggestions-container" style="border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto; position:absolute; background:white;"></div>
        </div>
        <br><br>

        <!-- Paid By -->
        <label>Paid By:</label>
        <select id="user-select" name="user_id" required onchange="handleUserChange(this)">
            <option value="" disabled selected>Select user</option>
            {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id|string %}selected{% endif %}>
                    {{ user.name }}
                </option>
            {% endfor %}
            <option value="manage">➕ Add/Remove Users</option>
        </select><br><br>

        <!-- Date -->
        <div>
            <label>Date:</label>
            <input type="date" name="date" value="{{ date or '' }}">
        </div>
        <br>

        <button type="submit">Add Expense</button>
    </form>

    <br>
    <a href="{{ url_for('expenses.expenses') }}">View All Expenses</a><br>
    <a href="{{ url_for('manage.management') }}">⬅ Back to Management</a>

<hr>
{% include "_expenses_table.html" %}

<script id="categories-data" type="application/json">{{ categories | tojson | safe }}</script>
<script id="users-data" type="application/json">{{ users | tojson | safe }}</script>
<script>
    const urls = {
        addExpense: "{{ url_for('expenses.add_expense') }}",
        manageCategories: "{{ url_for('categories.manage_categories') }}",
        manageUsers: "{{ url_for('users.manage_users') }}"
    };

    // Handle category change inline
    function handleCategoryChange(select) {
        if (select.value === "manage") {
            const nextUrl = encodeURIComponent(window.location.href);
            window.location.href = urls.manageCategories + "?next=" + nextUrl;
            return;
        }
        
        const descContainer = document.getElementById("category-desc-container");
        if (select.value) {
            descContainer.style.display = "block";
        } else {
            descContainer.style.display = "none";
        }
    }

    // Handle user change inline
    function handleUserChange(select) {
        if (select.value === "manage") {
            const nextUrl = encodeURIComponent(window.location.href);
            window.location.href = urls.manageUsers + "?next=" + nextUrl;
            return;
        }
    }
</script>
<script src="{{ url_for('static', filename='js/add_expense_form.js') }}"></script>
<script src="{{ url_for('static', filename='js/expenses_table.js') }}"></script>

</body>
</html>