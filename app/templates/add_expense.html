<!DOCTYPE html>
<html>
<head>
    <title>RoomMate Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/balance-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roommate-styles.css') }}">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>
            üè† RoomMate Tracker
            <span class="version">v2.0</span>
        </h1>
        <div class="status-indicator all-even">All Even</div>
    </div>

    {% if error %}
        <div class="error-message">{{ error }}</div>
    {% endif %}

    <!-- Main Layout -->
    <div class="main-layout">
        {% include 'balances_section.html' %}
        {% include 'right_section.html' %}
    </div>

    <!-- Expenses Section -->
    <div class="expenses-section">
        <!-- The expenses table will go here -->
        {% include "_expenses_table.html" %}
    

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Expense</h2>
                <button class="close-btn" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <form method="POST" id="expense-form">
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="category-select" name="category_id" required onchange="handleCategoryChange(this)">
                        <option value="" disabled selected>Select category</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if selected_category_id == cat.id|string %}selected{% endif %}>
                                {{ cat.name }}
                            </option>
                        {% endfor %}
                        <option value="manage">‚ûï Add/Remove Categories</option>
                    </select>
                </div>

                <div id="category-desc-container" class="form-group" style="display:none;">
                    <label>Description / Store</label>
                    <input type="text" id="category-description" name="category_description" value="{{ category_description or '' }}" autocomplete="off">
                    <div id="suggestions-container" style="border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto; position:absolute; background:white; z-index:1001;"></div>
                </div>

                <div class="form-group">
                    <label>Paid By</label>
                    <select id="user-select" name="user_id" required onchange="handleUserChange(this)">
                        <option value="" disabled selected>Select user</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if selected_user_id == user.id|string %}selected{% endif %}>
                                {{ user.name }}
                            </option>
                        {% endfor %}
                        <option value="manage">‚ûï Add/Remove Users</option>
                    </select>
                </div>

                <div class="participants-section">
                    <div class="participants-title">Who participated in this expense?</div>
                    <div class="participants-subtitle">Select everyone who should split this expense</div>
                    
                    <button type="button" class="select-all-btn" onclick="toggleAllParticipants()">Select All</button>

                    <div id="participants-list" class="participants-grid">
                        {% for user in users %}
                        <div class="participant-checkbox">
                            <input type="checkbox" 
                                id="participant-{{ user.id }}" 
                                name="participant_ids" 
                                value="{{ user.id }}"
                                onchange="updateSplitPreview()">
                            <label for="participant-{{ user.id }}">{{ user.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div id="split-preview" class="split-preview" style="display: none;">
                        <strong>Split Preview:</strong>
                        <div id="split-details"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="date" value="{{ date or '' }}">
                </div>

                <button type="submit" class="submit-btn">Add Expense</button>
            </form>
            </div>
        </div>
    </div>

    <!-- Settle Up Modal -->
    <div id="settleUpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settle Up</h2>
                <button class="close-btn" onclick="closeModal('settleUpModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                    All balances are settled! üéâ
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Links -->
    <div style="margin-top: 30px; text-align: center; color: #7f8c8d;">
        <a href="{{ url_for('expenses.expenses') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">üìä View All Expenses</a>
        <a href="{{ url_for('balances.balances_page') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">üí∞ View Balances</a>
        <a href="{{ url_for('manage.management') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">‚öôÔ∏è Settings</a>
    </div>

    <!-- JavaScript -->
    <script id="categories-data" type="application/json">{{ categories | tojson | safe }}</script>
    <script id="users-data" type="application/json">{{ users | tojson | safe }}</script>

    <script>
        // Modal functions
        function openAddExpenseModal() {
            document.getElementById('addExpenseModal').style.display = 'block';
        }

        function openSettleUpModal() {
            document.getElementById('settleUpModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Category handling
        function handleCategoryChange(select) {
            const descContainer = document.getElementById('category-desc-container');
            if (select.value === 'manage') {
                window.location.href = "{{ url_for('categories.manage_categories') }}?next=" + encodeURIComponent(window.location.href);
                return;
            }
            
            if (select.value && select.value !== 'manage') {
                descContainer.style.display = 'block';
            } else {
                descContainer.style.display = 'none';
            }
        }

        // User handling
        function handleUserChange(select) {
            if (select.value === 'manage') {
                window.location.href = "{{ url_for('users.manage_users') }}?next=" + encodeURIComponent(window.location.href);
                return;
            }
            
            // Auto-select payer as participant
            const payerCheckbox = document.getElementById(`participant-${select.value}`);
            if (payerCheckbox && !payerCheckbox.checked) {
                payerCheckbox.checked = true;
                updateSplitPreview();
            }
        }

        // Participant handling
        function toggleAllParticipants() {
            const checkboxes = document.querySelectorAll('input[name="participant_ids"]');
            const anyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = anyUnchecked;
            });
            
            updateSplitPreview();
        }

        function updateSplitPreview() {
            const participantCheckboxes = document.querySelectorAll('input[name="participant_ids"]:checked');
            const splitPreview = document.getElementById('split-preview');
            const splitDetails = document.getElementById('split-details');
            const amountInput = document.querySelector('input[name="amount"]');
            
            if (!splitPreview || !splitDetails) return;
            
            const amount = parseFloat(amountInput?.value) || 0;
            const participantCount = participantCheckboxes.length;
            
            if (amount > 0 && participantCount > 0) {
                const sharePerPerson = amount / participantCount;
                
                let detailsHtml = `<div>Total: $${amount.toFixed(2)} √∑ ${participantCount} people = $${sharePerPerson.toFixed(2)} per person</div>`;
                detailsHtml += '<div style="margin-top: 8px; font-size: 0.85em;">Participants: ';
                
                const participantNames = [];
                participantCheckboxes.forEach(checkbox => {
                    const label = document.querySelector(`label[for="${checkbox.id}"]`);
                    if (label) {
                        participantNames.push(label.textContent);
                    }
                });
                
                detailsHtml += participantNames.join(', ') + '</div>';
                
                splitDetails.innerHTML = detailsHtml;
                splitPreview.style.display = 'block';
            } else {
                splitPreview.style.display = 'none';
            }
        }

        // Make URLs available to JavaScript modules
        window.urls = {
            addExpense: "{{ url_for('expenses.add_expense') }}",
            manageCategories: "{{ url_for('categories.manage_categories') }}",
            manageUsers: "{{ url_for('users.manage_users') }}"
        };

        // Load existing JavaScript functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load balances and settlements data
            loadBalancesData();
            
            // Initialize autocomplete
            const descInput = document.getElementById('category-description');
            if (descInput && window.createAutocomplete) {
                window.createAutocomplete(descInput, 'suggestions-container');
            }
            
            // Initialize expense table manager if expenses exist
            const expenseTable = document.querySelector('table');
            if (expenseTable && window.ExpenseTableManager) {
                new window.ExpenseTableManager({
                    tableSelector: 'table',
                    errorSelector: '#table-error',
                    urls: window.urls
                });
            }
            
            // Initialize expense form manager
            if (window.ExpenseFormManager) {
                new window.ExpenseFormManager({
                    formSelector: '#expense-form',
                    urls: window.urls
                });
            }
        });

        // Load balances data from API
        async function loadBalancesData() {
            try {
                const [balancesResponse, settlementsResponse] = await Promise.all([
                    fetch('/api/balances'),
                    fetch('/api/settlements')
                ]);
                
                const balancesData = await balancesResponse.json();
                const settlementsData = await settlementsResponse.json();
                
                updateBalancesDisplay(balancesData.balances);
                updateSettlementsDisplay(settlementsData.settlements);
                updateHeaderStatus(balancesData.balances);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('balances-container').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading balances</div>';
            }
        }

        function updateBalancesDisplay(balances) {
            const container = document.getElementById('balances-container');
            if (!balances || balances.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">No users found</div>';
                return;
            }

            const balanceItems = balances.map(balance => {
                const initial = balance.user_name.charAt(0).toUpperCase();
                const status = balance.balance > 0.01 ? 'positive' : balance.balance < -0.01 ? 'negative' : 'even';
                const statusText = balance.balance > 0.01 ? 'owed' : balance.balance < -0.01 ? 'owes' : 'even';
                const amount = Math.abs(balance.balance);

                return `
                    <div class="balance-item ${status}">
                        <div class="user-info">
                            <div class="user-avatar">${initial}</div>
                            <div>
                                <div class="user-name">${balance.user_name}</div>
                            </div>
                        </div>
                        <div class="balance-amount">
                            <div class="amount">${amount.toFixed(2)}</div>
                            <div class="status">${statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = balanceItems;
        }

        function updateSettlementsDisplay(settlements) {
            const container = document.getElementById('settlements-container');
            
            if (!settlements || settlements.length === 0) {
                container.innerHTML = '<div class="no-settlements">üéâ All settled! No payments needed.</div>';
                return;
            }

            const settlementItems = settlements.map(settlement => `
                <div class="settlement-item">
                    <strong>${settlement.from}</strong> should pay <strong>${settlement.to}</strong> 
                    <span class="settlement-amount">${settlement.amount.toFixed(2)}</span>
                </div>
            `).join('');

            container.innerHTML = settlementItems;
        }

        function updateHeaderStatus(balances) {
            const statusIndicator = document.querySelector('.status-indicator');
            if (!statusIndicator) return;

            const hasImbalances = balances.some(b => Math.abs(b.balance) > 0.01);
            
            if (hasImbalances) {
                statusIndicator.textContent = 'Pending Settlements';
                statusIndicator.className = 'status-indicator pending';
                statusIndicator.style.background = '#fff3cd';
                statusIndicator.style.color = '#856404';
            } else {
                statusIndicator.textContent = 'All Even';
                statusIndicator.className = 'status-indicator all-even';
            }
        }
    </script>

    <!-- Load your existing JavaScript modules -->
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/expense-table-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/expense-form-manager.js') }}"></script>
</body>
</html>