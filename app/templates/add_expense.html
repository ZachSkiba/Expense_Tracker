<!DOCTYPE html>
<html>
<head>
    <title>RoomMate Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/balance-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roommate-styles.css') }}">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>
            üè† 403 Expense Tracker
            <span class="version">v2.0</span>
        </h1>
        <div class="status-indicator all-even">All Even</div>
    </div>

    {% if error %}
        <div class="error-message">{{ error }}</div>
    {% endif %}

    <!-- Main Layout -->
    <div class="main-layout">
        {% include 'balances_section.html' %}
        {% include 'right_section.html' %}
    </div>

    <!-- Expenses Section -->
    <div class="expenses-section">
        <!-- The expenses table will go here -->
        {% include "_expenses_table.html" %}
    

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Expense</h2>
                <button class="close-btn" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <form method="POST" id="expense-form">
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="category-select" name="category_id" required onchange="handleCategoryChange(this)">
                        <option value="" disabled selected>Select category</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if selected_category_id == cat.id|string %}selected{% endif %}>
                                {{ cat.name }}
                            </option>
                        {% endfor %}
                        <option value="manage">‚ûï Add/Remove Categories</option>
                    </select>
                </div>

                <div id="category-desc-container" class="form-group" style="display:none;">
                    <label>Description / Store</label>
                    <input type="text" id="category-description" name="category_description" value="{{ category_description or '' }}" autocomplete="off">
                    <div id="suggestions-container" style="border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto; position:absolute; background:white; z-index:1001;"></div>
                </div>

                <div class="form-group">
                    <label>Paid By</label>
                    <select id="user-select" name="user_id" required onchange="handleUserChange(this)">
                        <option value="" disabled selected>Select user</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if selected_user_id == user.id|string %}selected{% endif %}>
                                {{ user.name }}
                            </option>
                        {% endfor %}
                        <option value="manage">‚ûï Add/Remove Users</option>
                    </select>
                </div>

                <div class="participants-section">
                    <div class="participants-title">Who participated in this expense?</div>
                    <div class="participants-subtitle">Select everyone who should split this expense</div>
                    
                    <button type="button" class="select-all-btn" onclick="toggleAllParticipants()">Select All</button>

                    <div id="participants-list" class="participants-grid">
                        {% for user in users %}
                        <div class="participant-checkbox">
                            <input type="checkbox" 
                                id="participant-{{ user.id }}" 
                                name="participant_ids" 
                                value="{{ user.id }}"
                                onchange="updateSplitPreview()">
                            <label for="participant-{{ user.id }}">{{ user.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div id="split-preview" class="split-preview" style="display: none;">
                        <strong>Split Preview:</strong>
                        <div id="split-details"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="date" value="{{ date or '' }}">
                </div>

                <button type="submit" class="submit-btn">Add Expense</button>
            </form>
            </div>
        </div>
    </div>

    <!-- Settle Up Modal -->
    <div id="settleUpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settle Up</h2>
                <button class="close-btn" onclick="closeModal('settleUpModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                    All balances are settled! üéâ
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Links -->
    <div style="margin-top: 30px; text-align: center; color: #7f8c8d;">
        <a href="{{ url_for('expenses.expenses') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">üìä View All Expenses</a>
        <a href="{{ url_for('balances.balances_page') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">üí∞ View Balances</a>
        <a href="{{ url_for('manage.management') }}" style="color: #3498db; text-decoration: none; margin: 0 15px;">‚öôÔ∏è Settings</a>
    </div>

    <!-- JavaScript -->
    <script id="categories-data" type="application/json">{{ categories | tojson | safe }}</script>
    <script id="users-data" type="application/json">{{ users | tojson | safe }}</script>

    <script>
        window.urls = {
            addExpense: "{{ url_for('expenses.add_expense') }}",
            manageCategories: "{{ url_for('categories.manage_categories') }}",
            manageUsers: "{{ url_for('users.manage_users') }}"
        };
    </script>


    <!-- Load your existing JavaScript modules -->
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/expense-table-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/expense-form-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>