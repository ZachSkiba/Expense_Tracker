<!DOCTYPE html>
<html>
<head>
    <title>Add Expense</title>
     <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Add Expense</h1>

    {% if error %}
        <p style="color:red;">{{ error }}</p>
    {% endif %}

    

    <form method="POST" id="expense-form">
        <!-- Amount -->
        <label>Amount:</label>
        <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required><br><br>

        <!-- Category -->
        <label>Category:</label>
        <select id="category-select" name="category_id" required onchange="handleCategoryChange(this)">
            <option value="" disabled selected>Select category</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if selected_category_id == cat.id|string %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
            <option value="manage">âž• Add/Remove Categories</option>
        </select>

        <!-- Description / Store -->
        <div id="category-desc-container" style="display:none;">
            <label>Description / Store:</label>
            <input type="text" id="category-description" name="category_description" value="{{ category_description or '' }}" autocomplete="off">
            <div id="suggestions-container" style="border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto; position:absolute; background:white;"></div>
        </div>
        <br><br>

        <!-- Paid By -->
        <label>Paid By:</label>
        <select id="user-select" name="user_id" required onchange="handleUserChange(this)">
            <option value="" disabled selected>Select user</option>
            {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id|string %}selected{% endif %}>
                    {{ user.name }}
                </option>
            {% endfor %}
            <option value="manage">âž• Add/Remove Users</option>
        </select><br><br>

        <!-- NEW: Participants Section -->
        <div class="participants-section">
            <label><strong>Who participated in this expense?</strong></label>
            <p style="font-size: 0.9em; color: #666; margin: 5px 0 15px 0;">
                Select everyone who should split this expense (including the person who paid if they participated)
            </p>
            
            <div id="participants-list">
                {% for user in users %}
                <div class="participant-checkbox">
                    <input type="checkbox" 
                           id="participant-{{ user.id }}" 
                           name="participant_ids" 
                           value="{{ user.id }}"
                           onchange="updateSplitPreview()">
                    <label for="participant-{{ user.id }}">{{ user.name }}</label>
                </div>
                {% endfor %}
            </div>
            
            <div id="split-preview" class="split-preview" style="display: none;">
                <strong>Split Preview:</strong>
                <div id="split-details"></div>
            </div>
        </div>

        <!-- Date -->
        <div>
            <label>Date:</label>
            <input type="date" name="date" value="{{ date or '' }}">
        </div>
        <br>

        <button type="submit">Add Expense</button>
    </form>

    <br>
    <a href="{{ url_for('expenses.expenses') }}">View All Expenses</a><br>
    <a href="{{ url_for('balances.balances_page') }}">ðŸ’° View Balances</a><br>
    <a href="{{ url_for('manage.management') }}">â¬… Back to Management</a>

<hr>
{% include "_expenses_table.html" %}

<!-- Data for JavaScript (needed for both form and table functionality) -->
<script id="categories-data" type="application/json">{{ categories | tojson | safe }}</script>
<script id="users-data" type="application/json">{{ users | tojson | safe }}</script>

<script>
    const urls = {
        addExpense: "{{ url_for('expenses.add_expense') }}",
        manageCategories: "{{ url_for('categories.manage_categories') }}",
        manageUsers: "{{ url_for('users.manage_users') }}"
    };

    // Handle category change inline
    function handleCategoryChange(select) {
        if (select.value === "manage") {
            const nextUrl = encodeURIComponent(window.location.href);
            window.location.href = urls.manageCategories + "?next=" + nextUrl;
            return;
        }
        
        const descContainer = document.getElementById("category-desc-container");
        if (select.value) {
            descContainer.style.display = "block";
        } else {
            descContainer.style.display = "none";
        }
    }

    // Handle user change inline
    function handleUserChange(select) {
        if (select.value === "manage") {
            const nextUrl = encodeURIComponent(window.location.href);
            window.location.href = urls.manageUsers + "?next=" + nextUrl;
            return;
        }
    

    // Auto-select the payer as a participant
        const payerId = select.value;
        if (payerId) {
            const payerCheckbox = document.getElementById(`participant-${payerId}`);
            if (payerCheckbox && !payerCheckbox.checked) {
                payerCheckbox.checked = true;
                updateSplitPreview();
            }
        }
    }

// Update split preview when amount or participants change
    function updateSplitPreview() {
        const amountInput = document.getElementById('amount-input');
        const participantCheckboxes = document.querySelectorAll('input[name="participant_ids"]:checked');
        const splitPreview = document.getElementById('split-preview');
        const splitDetails = document.getElementById('split-details');
        
        const amount = parseFloat(amountInput.value) || 0;
        const participantCount = participantCheckboxes.length;
        
        if (amount > 0 && participantCount > 0) {
            const sharePerPerson = amount / participantCount;
            
            let detailsHtml = `<div>Total: ${amount.toFixed(2)} Ã· ${participantCount} people = ${sharePerPerson.toFixed(2)} per person</div>`;
            detailsHtml += '<div style="margin-top: 8px; font-size: 0.85em;">Participants: ';
            
            const participantNames = [];
            participantCheckboxes.forEach(checkbox => {
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                participantNames.push(label.textContent);
            });
            
            detailsHtml += participantNames.join(', ') + '</div>';
            
            splitDetails.innerHTML = detailsHtml;
            splitPreview.style.display = 'block';
        } else {
            splitPreview.style.display = 'none';
        }
    }

    // Form validation
    document.getElementById('expense-form').addEventListener('submit', function(e) {
        const participantCheckboxes = document.querySelectorAll('input[name="participant_ids"]:checked');
        
        if (participantCheckboxes.length === 0) {
            e.preventDefault();
            alert('Please select at least one participant for this expense.');
            return false;
        }
        
        // Check if category or user is set to "manage"
        const categorySelect = document.getElementById('category-select');
        const userSelect = document.getElementById('user-select');
        
        if (categorySelect.value === "manage" || userSelect.value === "manage") {
            e.preventDefault();
            return false;
        }
    });

    // Initialize form
    document.addEventListener('DOMContentLoaded', function() {
        // Show category description if category is already selected
        const categorySelect = document.getElementById('category-select');
        if (categorySelect.value && categorySelect.value !== 'manage') {
            document.getElementById('category-desc-container').style.display = 'block';
        }
        
        // Update split preview on page load
        updateSplitPreview();
    });
</script>

<!-- Load scripts for form and table functionality -->
<script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/add_expense_form.js') }}"></script>
<script src="{{ url_for('static', filename='js/expenses_table.js') }}"></script>

</body>
</html>