<!DOCTYPE html>
<html>
<head>
    <title>Balances & Settlements</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/balance-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settlements.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settlements-table.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/payments-balances.css') }}">
</head>
<body>

<div class="page-header">
    <h1 class="page-title">üí∞ Balances & Settlements</h1>
    <div class="header-navigation">
        <a href="{{ url_for('expenses.add_expense') }}" class="header-nav-link">‚ûï Add Expense</a>
        <a href="{{ url_for('expenses.expenses') }}" class="header-nav-link">üìä View Expenses</a>
        <a href="{{ url_for('manage.management') }}" class="header-nav-link">‚öôÔ∏è Management</a>
    </div>
</div>

<div class="top-navigation">
    <a href="{{ url_for('expenses.add_expense') }}" class="nav-link">‚ûï Add New Expense</a>
    <a href="{{ url_for('expenses.expenses') }}" class="nav-link">üìä View All Expenses</a>
    <a href="{{ url_for('manage.management') }}" class="nav-link">‚öôÔ∏è Management</a>
</div>

<div class="main-container">
    <!-- Left Section: Current Balances -->
    <div class="section">
        <h2 class="section-title">Current Balances</h2>
        
        <div class="balance-list" id="balances-container">
            {% for balance in balances %}
            <div class="balance-item {% if balance.balance > 0.01 %}positive{% elif balance.balance < -0.01 %}negative{% else %}even{% endif %}">
                <div class="user-info">
                    <div class="user-avatar">{{ balance.user_name[0]|upper }}</div>
                    <div>
                        <div class="user-name">{{ balance.user_name }}</div>
                    </div>
                </div>
                <div class="balance-amount">
                    {% if balance.balance > 0.01 %}
                        <div class="amount">+${{ "%.2f"|format(balance.balance) }}</div>
                        <div class="status">is owed</div>
                    {% elif balance.balance < -0.01 %}
                        <div class="amount">-${{ "%.2f"|format(balance.balance|abs) }}</div>
                        <div class="status">owes</div>
                    {% else %}
                        <div class="amount">$0.00</div>
                        <div class="status">even</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        {% if settlements %}
        <div class="settlement-suggestions">
            <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem;">üí° Suggested Settlements</h3>
            <p style="margin-bottom: 15px; color: #6c757d; font-size: 0.9rem;">To settle all debts with minimum transactions:</p>
            
            {% for settlement in settlements %}
            <div class="settlement-card">
                <strong>{{ settlement.from }}</strong> should pay <strong>{{ settlement.to }}</strong> 
                <span class="balance-positive">${{ "%.2f"|format(settlement.amount) }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="settlement-suggestions">
            <div class="settlement-card" style="background: #e8f5e8; border-color: #c3e6cb;">
                üéâ All Settled! Everyone is even - no settlements needed!
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Section: Record Payments & History -->
    <div class="section">
        <h2 class="section-title">Record New Payment</h2>
        
        {% if error %}
            <div class="error-message">{{ error }}</div>
        {% endif %}

        <form method="POST" class="settlement-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Amount Paid</label>
                    <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="date" value="{{ date or '' }}" autocomplete="off">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Who Paid</label>
                    <select name="payer_id" required autocomplete="off">
                        <option value="" disabled {% if not payer_id %}selected{% endif %}>Select payer</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if payer_id == user.id|string %}selected{% endif %}>
                                {{ user.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Who Received Payment</label>
                    <select name="receiver_id" required autocomplete="off">
                        <option value="" disabled {% if not receiver_id %}selected{% endif %}>Select receiver</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if receiver_id == user.id|string %}selected{% endif %}>
                                {{ user.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description (Optional)</label>
                <input type="text" name="description" value="{{ description or '' }}" placeholder="e.g., Venmo payment, cash, etc." autocomplete="off">
            </div>

            <button type="submit" class="submit-btn">üí∏ Record Payment</button>
        </form>

        <div class="payments-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem;">üìã Recent Payments</h3>
            
            {% if settlements_data %}
            <div id="table-error" style="margin: 8px 0; display: none;"></div>
            <table class="settlements-table">
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for settlement in settlements_data %}
                    <tr data-settlement-id="{{ settlement.id }}">
                        <td class="editable amount" data-field="amount" data-value="{{ "%.2f"|format(settlement.amount) }}">
                            ${{ "%.2f"|format(settlement.amount) }}
                        </td>
                        <td class="editable payer" data-field="payer" data-value="{{ settlement.payer_name }}">
                            {{ settlement.payer_name }}
                        </td>
                        <td class="editable receiver" data-field="receiver" data-value="{{ settlement.receiver_name }}">
                            {{ settlement.receiver_name }}
                        </td>
                        <td class="editable description" data-field="description" data-value="{{ settlement.description or '' }}">
                            {{ settlement.description or '-' }}
                        </td>
                        <td class="editable date" data-field="date" data-value="{{ settlement.date }}">
                            {{ settlement.date }}
                        </td>
                        <td>
                            <button class="delete-settlement-btn" data-settlement-id="{{ settlement.id }}" style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚ùå Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-payments">üí∏ No payments recorded yet</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Users data for JavaScript -->
<script id="users-data" type="application/json">{{ users | tojson | safe }}</script>

<script>
// Combined Settlement Table Editor (from settlements.html)
class SettlementTableEditor {
    constructor() {
        this.usersData = JSON.parse(document.getElementById('users-data').textContent || '[]');
        this.isEditing = false;
        this.editingCell = null;
        this.originalContent = null;
        this.initializeEditing();
        this.initializeDeleteButtons();
    }

    initializeEditing() {
        const editableCells = document.querySelectorAll('.settlements-table .editable');
        
        editableCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
                e.stopPropagation();
                this.startEditing(cell);
            });
        });
    }

    initializeDeleteButtons() {
        document.querySelectorAll('.delete-settlement-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const settlementId = button.getAttribute('data-settlement-id');
                this.deleteSettlement(settlementId);
            });
        });
    }

    startEditing(cell) {
        if (this.isEditing) return;

        this.isEditing = true;
        this.editingCell = cell;
        
        const currentValue = cell.getAttribute('data-value') || '';
        const fieldType = cell.getAttribute('data-field');
        
        cell.classList.add('editing');
        
        let inputElement;
        
        if (fieldType === 'amount') {
            inputElement = document.createElement('input');
            inputElement.type = 'number';
            inputElement.step = '0.01';
            inputElement.min = '0.01';
            inputElement.value = currentValue;
        } else if (fieldType === 'date') {
            inputElement = document.createElement('input');
            inputElement.type = 'date';
            inputElement.value = currentValue;
        } else if (fieldType === 'payer' || fieldType === 'receiver') {
            inputElement = document.createElement('select');
            this.usersData.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name;
                option.selected = user.name === currentValue;
                inputElement.appendChild(option);
            });
        } else {
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.value = currentValue;
        }
        
        inputElement.style.width = '100%';
        inputElement.style.border = '2px solid #3498db';
        inputElement.style.padding = '4px';
        inputElement.style.borderRadius = '4px';
        inputElement.style.boxSizing = 'border-box';
        
        this.originalContent = cell.innerHTML;
        cell.innerHTML = '';
        cell.appendChild(inputElement);
        
        inputElement.focus();
        if (inputElement.type === 'text' || inputElement.type === 'number') {
            inputElement.select();
        }
        
        const handleSave = async () => {
            await this.saveEdit(inputElement);
        };
        
        const handleCancel = () => {
            this.cancelEdit();
        };
        
        inputElement.addEventListener('blur', handleSave, { once: true });
        
        inputElement.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                inputElement.blur();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                e.stopPropagation();
                handleCancel();
            }
        });
    }

    async saveEdit(inputElement) {
        if (!this.isEditing || !this.editingCell) return;

        const newValue = inputElement.value.trim();
        const cell = this.editingCell;
        const settlementId = cell.closest('tr').getAttribute('data-settlement-id');
        const fieldType = cell.getAttribute('data-field');
        const originalValue = cell.getAttribute('data-value') || '';
        
        if (newValue === originalValue) {
            this.cancelEdit();
            return;
        }

        try {
            const updateData = {};
            updateData[fieldType] = newValue;

            const response = await fetch(`/edit_settlement/${settlementId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });

            const data = await response.json();

            if (data.success) {
                cell.setAttribute('data-value', newValue);
                
                if (fieldType === 'amount') {
                    cell.innerHTML = `$${parseFloat(newValue).toFixed(2)}`;
                } else if (fieldType === 'description' && !newValue) {
                    cell.innerHTML = '-';
                } else {
                    cell.innerHTML = newValue;
                }
                
                cell.classList.remove('editing');
                this.isEditing = false;
                this.editingCell = null;
                this.originalContent = null;
                
                this.showSuccessMessage('Settlement updated successfully');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } else {
                throw new Error(data.error || 'Update failed');
            }
        } catch (error) {
            console.error('Error saving settlement edit:', error);
            this.cancelEdit();
            this.showErrorMessage('Failed to update settlement: ' + error.message);
        }
    }

    cancelEdit() {
        if (!this.isEditing || !this.editingCell) return;

        const cell = this.editingCell;
        cell.innerHTML = this.originalContent;
        cell.classList.remove('editing');
        
        this.isEditing = false;
        this.editingCell = null;
        this.originalContent = null;
    }

    async deleteSettlement(settlementId) {
        if (!confirm('Are you sure you want to delete this settlement? This will reverse the balance changes.')) {
            return;
        }

        try {
            const response = await fetch(`/delete_settlement/${settlementId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                this.showSuccessMessage('Payment deleted successfully');
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                this.showErrorMessage('Error deleting settlement: ' + data.error);
            }
        } catch (error) {
            console.error('Error deleting settlement:', error);
            this.showErrorMessage('Error deleting settlement: ' + error.message);
        }
    }

    showSuccessMessage(message) {
        this.showTableMessage(message, 'success');
    }

    showErrorMessage(message) {
        this.showTableMessage(message, 'error');
    }

    showTableMessage(message, type = 'error') {
        const errorDiv = document.getElementById('table-error');
        if (errorDiv) {
            errorDiv.className = type;
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<div style="padding: 8px; border-radius: 4px; ${
                type === 'success' ? 'background: #d4edda; border: 1px solid #c3e6cb; color: #155724;' 
                : 'background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24;'
            }">${message}</div>`;
            
            if (type !== 'success') {
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }
    }
}

// Initialize when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    new SettlementTableEditor();
});
</script>

</body>
</html>