<!DOCTYPE html>
<html>
<head>
    <title>Balances & Settlements</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/balance-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settlements.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settlements-table.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/payments-balances.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-optimization.css') }}">
</head>
<body>

<div class="page-header">
    <h1 class="page-title">üí∞ Balances & Settlements</h1>
    <div class="header-navigation">
        <a href="{{ url_for('expenses.group_tracker', group_id=group.id) }}" class="header-nav-link">‚¨Ö Main Page</a>
        <a href="{{ url_for('expenses.group_expenses', group_id=group.id) }}" class="header-nav-link">üìä View Expenses</a>
        <a href="{{ url_for('manage.management', group_id=group.id) }}" class="header-nav-link">‚öôÔ∏è Management</a>
    </div>
</div>

<div class="main-container">
    <!-- Left Section: Current Balances -->
    <div class="section">
        <h2 class="section-title">Current Balances</h2>
        
        <div class="balance-list" id="balances-container">
            {% for balance in balances %}
            <div class="balance-item {% if balance.balance > 0.01 %}positive{% elif balance.balance < -0.01 %}negative{% else %}even{% endif %}">
                <div class="user-info">
                    <div class="user-avatar">{{ balance.user_name[0]|upper }}</div>
                    <div>
                        <div class="user-name">{{ balance.user_name }}</div>
                    </div>
                </div>
                <div class="balance-amount">
                    {% if balance.balance > 0.01 %}
                        <div class="amount">+${{ "%.2f"|format(balance.balance) }}</div>
                        <div class="status">is owed</div>
                    {% elif balance.balance < -0.01 %}
                        <div class="amount">-${{ "%.2f"|format(balance.balance|abs) }}</div>
                        <div class="status">owes</div>
                    {% else %}
                        <div class="amount">$0.00</div>
                        <div class="status">even</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        {% if settlements %}
        <div class="settlement-suggestions">
            <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem;">üí° Suggested Settlements</h3>
            <p style="margin-bottom: 15px; color: #6c757d; font-size: 0.9rem;">To settle all debts with minimum transactions:</p>
            
            {% for settlement in settlements %}
            <div class="settlement-card">
                <strong>{{ settlement.from }}</strong> should pay <strong>{{ settlement.to }}</strong> 
                <span class="balance-positive">${{ "%.2f"|format(settlement.amount) }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="settlement-suggestions">
            <div class="settlement-card" style="background: #e8f5e8; border-color: #c3e6cb;">
                üéâ All Settled! Everyone is even - no settlements needed!
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Section: Record Payments & History -->
    <div class="section">
        <h2 class="section-title">Record New Payment</h2>
        
        {% if error %}
            <div class="error-message">{{ error }}</div>
        {% endif %}

        <form method="POST" class="settlement-form">
            <div class="form-row">
                <div class="form-group">
                    <label>Amount Paid</label>
                    <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="date" value="{{ date or '' }}" autocomplete="off">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>From</label>
                    <select name="payer_id" required autocomplete="off">
                        <option value="" disabled {% if not payer_id %}selected{% endif %}>Select payer</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if payer_id == user.id|string %}selected{% endif %}>
                                {{ user.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>To</label>
                    <select name="receiver_id" required autocomplete="off">
                        <option value="" disabled {% if not receiver_id %}selected{% endif %}>Select receiver</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if receiver_id == user.id|string %}selected{% endif %}>
                                {{ user.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description (Optional)</label>
                <input type="text" name="description" value="{{ description or '' }}" placeholder="e.g., Venmo payment, cash, etc." autocomplete="off">
            </div>

            <button type="submit" id="record-payment-btn" class="submit-btn">üí∏ Record Payment</button>
        </form>

        <div class="payments-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #2c3e50; margin: 0; font-size: 1.1rem;">üìã Recent Payments</h3>
                <div class="totals-card payments-totals-card" style="margin: 0;">
                    <div class="totals-label">Total Payments</div>
                    <div class="totals-amount" id="payments-total">$0.00</div>
                </div>
            </div>
            
            {% if settlements_data %}
            <div id="table-error" style="margin: 8px 0; display: none;"></div>
            <table class="settlements-table">
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Description</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for settlement in settlements_data %}
                    <tr data-settlement-id="{{ settlement.id }}">
                        <td class="editable amount" data-field="amount" data-value="{{ "%.2f"|format(settlement.amount) }}">
                            ${{ "%.2f"|format(settlement.amount) }}
                        </td>
                        <td class="editable payer" data-field="payer" data-value="{{ settlement.payer_name }}">
                            {{ settlement.payer_name }}
                        </td>
                        <td class="editable receiver" data-field="receiver" data-value="{{ settlement.receiver_name }}">
                            {{ settlement.receiver_name }}
                        </td>
                        <td class="editable description" data-field="description" data-value="{{ settlement.description or '' }}">
                            {{ settlement.description or '-' }}
                        </td>
                        <td class="editable date" data-field="date" data-value="{{ settlement.date }}">
                            {{ settlement.date }}
                        </td>
                        <td>
                            <button class="delete-settlement-btn" data-settlement-id="{{ settlement.id }}" style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚ùå Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="no-payments">üí∏ No payments recorded yet</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Users data for JavaScript -->
<script id="users-data" type="application/json">{{ users | tojson | safe }}</script>

<!-- Load the complete settlement manager script -->
<script src="{{ url_for('static', filename='js/modules/settlement-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/totals-calculator.js') }}"></script>
<script src="{{ url_for('static', filename='main.js') }}"></script>
<script>

// Initialize totals calculator for balances page
document.addEventListener('DOMContentLoaded', function() {
    new TotalsCalculator();
});
</script>

</body>
</html>