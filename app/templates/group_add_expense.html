<!-- app/templates/group_add_expense.html -->
<!DOCTYPE html>
<html>
<head>
    <title>{{ group.name }} - Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/balance-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roommate-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settlements-table.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/expense-filter.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/recurring-payments.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-optimization.css') }}">
    <style>
        /* Group-specific header styling */
        .group-header {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .group-header h1 {
            margin: 0;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .group-meta {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .group-nav {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .group-nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .group-nav a:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        /* Override header styles for group page */
        .header {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 1.25rem;
        }
        
        .header-nav a {
            color: #4a5568;
            background: white;
            border: 1px solid #e2e8f0;
        }
        
        .header-nav a:hover {
            background: #edf2f7;
        }
        
        /* Group balances section */
        .group-balances {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }
        
        .balance-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .balance-positive {
            background: #f0fff4;
            border-color: #9ae6b4;
            color: #22543d;
        }
        
        .balance-negative {
            background: #fef2f2;
            border-color: #feb2b2;
            color: #742a2a;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>üí∞ Expense Tracker</h1>
        </div>

        <div class="header-center">
            <nav class="header-nav">
                <a href="{{ url_for('dashboard.home') }}">üè† Dashboard</a>
                <a href="{{ url_for('groups.detail', group_id=group.id) }}">üìã Group Details</a>
                <a href="{{ url_for('expenses.group_expenses', group_id=group.id) }}">üìä All Expenses</a>
                <a href="{{ url_for('expenses.manage_group_categories', group_id=group.id) }}">üìÇ Categories</a>
            </nav>
        </div>

        <div class="header-right">
            <div class="status-indicator">{{ group.name }}</div>
        </div>
    </div>

    <!-- Group Header -->
    <div class="group-header">
        <h1>{{ group.name }}</h1>
        <div class="group-meta">
            {{ group.get_member_count() }} members ‚Ä¢ 
            {% if group.description %}{{ group.description }}{% endif %}
        </div>
    </div>

    {% if error %}
        <div class="error-message">{{ error }}</div>
    {% endif %}

    <!-- Flash Messages -->
    {% for category, message in get_flashed_messages(with_categories=true) %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'error' }}">
            {{ message }}
        </div>
    {% endfor %}

    <!-- Group Balances Section -->
    <div class="group-balances">
        <h3>Group Balances</h3>
        <div class="balance-list" id="group-balances-container">
            <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                Loading balances...
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Left Section: Group Actions -->
        <div class="left-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">Quick Actions</h3>
            
            <div class="action-buttons" style="display: flex; flex-direction: column; gap: 10px;">
                <button class="add-expense-btn" onclick="openAddExpenseModal()">
                    ‚ûï Add Group Expense
                </button>
                <button class="settle-up-btn" onclick="openSettleUpModal()">
                    üí∞ Record Payment
                </button>
                <button class="recurring-payments-btn" onclick="openRecurringPaymentsModal()">
                    üîÑ Recurring Payments
                </button>
            </div>
        </div>

        <!-- Right Section: Recent Expenses -->
        <div class="right-section">
            <h3>Recent Expenses</h3>
            <div class="recent-expenses">
                {% for expense in expenses %}
                <div class="expense-item" style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                    <div>
                        <div style="font-weight: bold;">${{ "%.2f"|format(expense.amount) }}</div>
                        <div style="font-size: 0.9em; color: #666;">{{ expense.category_obj.name }}</div>
                        <div style="font-size: 0.8em; color: #999;">{{ expense.user.name }} ‚Ä¢ {{ expense.date.strftime('%m/%d') }}</div>
                    </div>
                    <div style="text-align: right; font-size: 0.8em; color: #999;">
                        {{ expense.participants|length }} people
                    </div>
                </div>
                {% else %}
                <div style="text-align: center; padding: 20px; color: #999;">
                    No expenses yet. Add your first expense!
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Expenses Section -->
    <div class="expenses-section">
        <!-- The expenses table will go here -->
        <div class="table-header">
            <div class="header-top">
                <h3>Recent Group Expenses <span class="expense-count">({{ expenses|length }})</span></h3>
            </div>
        </div>
        
        {% if expenses %}
        <div class="table-wrapper">
            <table class="expenses-table">
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Paid By</th>
                        <th>Participants</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr data-expense-id="{{ expense.id }}">
                        <td class="amount">${{ "%.2f"|format(expense.amount) }}</td>
                        <td class="category">{{ expense.category_obj.name }}</td>
                        <td class="description">{{ expense.category_description or '' }}</td>
                        <td class="user">{{ expense.user.name }}</td>
                        <td class="participants">
                            {% if expense.participants %}
                                {% for participant in expense.participants %}
                                    <span class="participant-tag">{{ participant.user.name }}</span>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                                <div style="font-size: 0.75rem; color: #999; margin-top: 2px;">
                                    ({{ expense.participants|length }} people, ${{ "%.2f"|format(expense.amount / expense.participants|length) }} each)
                                </div>
                            {% else %}
                                <span style="color: #999; font-style: italic;">No participants</span>
                            {% endif %}
                        </td>
                        <td class="date">{{ expense.date.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteGroupExpense('{{ expense.id }}')">‚ùå Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; background: white; border-radius: 8px; border: 1px solid #eee;">
            <h4 style="color: #666; margin-bottom: 10px;">No expenses yet</h4>
            <p style="color: #999; margin-bottom: 20px;">Start tracking your group expenses</p>
            <button class="add-expense-btn" onclick="openAddExpenseModal()">Add First Expense</button>
        </div>
        {% endif %}
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Group Expense</h2>
                <button class="close-btn" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <form method="POST" id="expense-form">
                <div class="form-group">
                    <label class="required">Amount</label>
                    <input type="number" step="0.01" min="0.01" name="amount" value="{{ request.form.get('amount', '') }}" required>
                </div>

                <div class="form-group">
                    <label class="required">Category</label>
                    <select id="category-select" name="category_id" required onchange="handleCategoryChange(this)">
                        <option value="" disabled selected>Select category</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if request.form.get('category_id') == cat.id|string %}selected{% endif %}>
                                {{ cat.name }}
                            </option>
                        {% endfor %}
                        <option value="manage">‚ûï Manage Categories</option>
                    </select>
                </div>

                <div id="category-desc-container" class="form-group" style="display:none;">
                    <label>Description / Store</label>
                    <input type="text" id="category-description" name="category_description" value="{{ request.form.get('category_description', '') }}" autocomplete="off">
                    <div id="suggestions-container" style="border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto; position:absolute; background:white; z-index:1001;"></div>
                </div>

                <div class="form-group">
                    <label class="required">Paid By</label>
                    <select id="user-select" name="user_id" required>
                        <option value="" disabled selected>Select group member</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if request.form.get('user_id') == user.id|string %}selected{% endif %}>
                                {{ user.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="participants-section">
                    <div class="participants-title">Who participated in this expense?</div>
                    <div class="participants-subtitle">Select group members who should split this expense</div>
                    
                    <button type="button" class="select-all-btn" onclick="toggleAllParticipants()">Select All Members</button>

                    <div id="participants-list" class="participants-grid">
                        {% for user in users %}
                        <div class="participant-checkbox">
                            <input type="checkbox" 
                                id="participant-{{ user.id }}" 
                                name="participant_ids" 
                                value="{{ user.id }}"
                                onchange="updateSplitPreview()">
                            <label for="participant-{{ user.id }}">{{ user.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div id="split-preview" class="split-preview" style="display: none;">
                        <strong>Split Preview:</strong>
                        <div id="split-details"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Date</label>
                    <input type="date" name="date" value="{{ request.form.get('date', '') }}">
                </div>

                <button type="submit" id="add-expense-btn" class="submit-btn">Add Group Expense</button>
            </form>
            </div>
        </div>
    </div>

    <!-- Settle Up Modal -->
    <div id="settleUpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ Record Group Payment</h2>
                <button class="close-btn" onclick="closeModal('settleUpModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="settlement-form">
                    <div class="form-group">
                        <label class="required">Amount Paid</label>
                        <input type="number" step="0.01" min="0.01" name="amount" required autocomplete="off">
                    </div>

                    <div class="form-group">
                        <label class="required">From (Group Member)</label>
                        <select name="payer_id" required autocomplete="off">
                            <option value="" disabled selected>Select payer</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">To (Group Member)</label>
                        <select name="receiver_id" required autocomplete="off">
                            <option value="" disabled selected>Select receiver</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description (Optional)</label>
                        <input type="text" name="description" placeholder="e.g., Venmo payment, cash, etc." autocomplete="off">
                    </div>

                    <div class="form-group">
                        <label class="required">Date</label>
                        <input type="date" name="date" autocomplete="off">
                    </div>

                    <input type="hidden" name="group_id" value="{{ group.id }}">

                    <div id="settlement-error" class="error-message" style="display: none;"></div>

                    <button type="submit" id="record-payment-btn" class="submit-btn">Record Group Payment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script id="categories-data" type="application/json">{{ categories | tojson | safe }}</script>
    <script id="users-data" type="application/json">{{ users | tojson | safe }}</script>
    <script id="group-data" type="application/json">{{ group | tojson | safe }}</script>

    <script>
        window.urls = {
            addExpense: "{{ url_for('expenses.add_group_expense', group_id=group.id) }}",
            groupBalances: "/api/group/{{ group.id }}/balances",
            groupSettlements: "/api/group/{{ group.id }}/settlements",
            deleteExpense: "{{ url_for('expenses.delete_group_expense', group_id=group.id, expense_id=0) }}".replace('0', ''),
            manageCategories: "{{ url_for('expenses.manage_group_categories', group_id=group.id) }}"
        };
        
        window.groupId = "{{ group.id }}";
        
        // Group-specific functions
        function deleteGroupExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            
            fetch(`${window.urls.deleteExpense}${expenseId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the expense');
            });
        }
        
        // Load group balances
        function loadGroupBalances() {
            fetch(window.urls.groupBalances)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('group-balances-container');
                    if (data.balances && data.balances.length > 0) {
                        container.innerHTML = data.balances.map(balance => {
                            const balanceClass = balance.amount > 0 ? 'balance-positive' : 
                                                balance.amount < 0 ? 'balance-negative' : 'balance-neutral';
                            const sign = balance.amount > 0 ? '+' : balance.amount < 0 ? '-' : '';
                            const amount = Math.abs(balance.amount).toFixed(2);
                            
                            return `
                                <div class="balance-item ${balanceClass}">
                                    <span>${balance.user_name}</span>
                                    <span>${sign}$${amount}</span>
                                </div>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 20px;">All settled up! üéâ</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading balances:', error);
                    document.getElementById('group-balances-container').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #e53e3e;">Error loading balances</div>';
                });
        }
        
        // Load balances on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadGroupBalances();
            
            // Set today's date as default
            const dateInputs = document.querySelectorAll('input[type="date"]');
            const today = new Date().toISOString().split('T')[0];
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
        });
    </script>

    <!-- Load existing JavaScript modules -->
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/expense-form-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>