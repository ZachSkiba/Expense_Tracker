<!DOCTYPE html>
<html>
<head>
    <title>Add Expense</title>
    <style>
        #category-desc-container {
            display: none;
            margin-top: 15px;
        }
        #suggestions-container div:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Add Expense</h1>

    {% if error %}
        <p style="color:red;">{{ error }}</p>
    {% endif %}

    <form method="POST">
        <!-- Amount -->
        <label>Amount:</label>
        <input type="number" step="0.01" min="0.01" name="amount" value="{{ amount or '' }}" required><br><br>

        <!-- Category -->
        <label>Category:</label>
        <select id="category-select" name="category_id" required>
            <option value="" disabled selected>Select category</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}" {% if selected_category_id == cat.id|string %}selected{% endif %}>
                    {{ cat.name }}
                </option>
            {% endfor %}
            <option value="manage">➕ Add/Remove Categories</option>
        </select>

        <!-- Description / Store -->
        <div id="category-desc-container">
            <label>Description / Store:</label><br>
            <input type="text" id="category-description" name="category_description" value="{{ category_description or '' }}" autocomplete="off">
            <div id="suggestions-container" style="border:1px solid #ccc; display:none; max-height:150px; overflow-y:auto; position:absolute; background:white;"></div>
        </div>
        <br><br>

        <!-- Paid By -->
        <label>Paid By:</label>
        <select id="user-select" name="user_id" required>
            <option value="" disabled selected>Select user</option>
            {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id|string %}selected{% endif %}>
                    {{ user.name }}
                </option>
            {% endfor %}
            <option value="manage">➕ Add/Remove Users</option>
        </select><br><br>

        <!-- Date -->
        <div>
            <label>Date:</label>
            <input type="date" name="date" value="{{ date or '' }}">
        </div>
        <br>

        <button type="submit">Add Expense</button>
    </form>

    <br>
    <a href="{{ url_for('expenses') }}">View All Expenses</a><br>
    <a href="{{ url_for('manage') }}">⬅ Back to Management</a>

    <!-- JS -->
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Category select logic
        const categorySelect = document.getElementById("category-select");
        const descContainer = document.getElementById("category-desc-container");

        categorySelect.addEventListener("change", function() {
            if (this.value && this.value !== "manage") {
                descContainer.style.display = "block";
            } else {
                descContainer.style.display = "none";
            }

            if (this.value === "manage") {
                window.location.href = "{{ url_for('manage_categories') }}";
            }
        });

        if (!categorySelect.value || categorySelect.value === "") {
            descContainer.style.display = "none";
        }

        // Paid By select logic
        const userSelect = document.getElementById("user-select");
        userSelect.addEventListener("change", function() {
            if (this.value === "manage") {
                window.location.href = "{{ url_for('manage_users') }}";
            }
        });

        // Description suggestions
        const input = document.getElementById("category-description");
        const container = document.getElementById("suggestions-container");

        input.addEventListener("input", function() {
            const query = this.value;
            if (!query) {
                container.style.display = "none";
                return;
            }

            fetch(`/store_suggestions?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    container.innerHTML = "";
                    if (data.suggestions.length === 0) {
                        container.style.display = "none";
                        return;
                    }

                    data.suggestions.forEach(s => {
                        const div = document.createElement("div");
                        div.textContent = s;
                        div.style.padding = "4px";
                        div.style.cursor = "pointer";
                        div.addEventListener("click", () => {
                            input.value = s;
                            container.style.display = "none";
                        });
                        container.appendChild(div);
                    });
                    container.style.display = "block";
                });
        });

        document.addEventListener("click", function(e) {
            if (e.target !== input) {
                container.style.display = "none";
            }
        });
    });
    </script>
</body>
</html>
